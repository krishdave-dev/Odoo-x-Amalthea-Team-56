// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  admin
  manager
  member
  finance

  @@map("user_role")
}

enum InvitationStatus {
  pending
  accepted
  rejected
  expired

  @@map("invitation_status")
}

// Organizations / Tenants
model Organization {
  id        Int      @id @default(autoincrement()) @map("organization_id")
  name      String
  currency  String   @default("INR") @db.Char(3)
  timezone  String   @default("Asia/Kolkata")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  users            User[]
  projects         Project[]
  salesOrders      SalesOrder[]
  purchaseOrders   PurchaseOrder[]
  customerInvoices CustomerInvoice[]
  vendorBills      VendorBill[]
  expenses         Expense[]
  attachments      Attachment[]
  events           Event[]
  notifications    Notification[]
  invitations      OrganizationInvitation[]

  @@map("organizations")
}

// Users (auth + profile)
model User {
  id             Int       @id @default(autoincrement()) @map("user_id")
  organizationId Int       @map("organization_id")
  email          String
  name           String?
  passwordHash   String?   @map("password_hash")
  role           UserRole  @default(member)
  hourlyRate     Decimal   @default(0.00) @map("hourly_rate") @db.Decimal(12, 2)
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  managedProjects     Project[]       @relation("ProjectManager")
  projectMembers      ProjectMember[]
  assignedTasks       Task[]
  timesheets          Timesheet[]
  expenses            Expense[]
  uploadedAttachments Attachment[]
  taskComments        TaskComment[]
  notifications       Notification[]
  sentInvitations     OrganizationInvitation[]

  @@unique([organizationId, email], map: "ux_users_org_email")
  @@map("users")
}

// Projects
model Project {
  id                Int       @id @default(autoincrement()) @map("project_id")
  organizationId    Int       @map("organization_id")
  name              String
  code              String?
  description       String?
  projectManagerId  Int?      @map("project_manager_id")
  startDate         DateTime? @map("start_date") @db.Date
  endDate           DateTime? @map("end_date") @db.Date
  status            String    @default("planned")
  budget            Decimal?  @db.Decimal(14, 2)
  cachedHoursLogged Decimal   @default(0) @map("cached_hours_logged") @db.Decimal(14, 2)
  cachedCost        Decimal   @default(0) @map("cached_cost") @db.Decimal(14, 2)
  cachedRevenue     Decimal   @default(0) @map("cached_revenue") @db.Decimal(14, 2)
  cachedProfit      Decimal   @default(0) @map("cached_profit") @db.Decimal(14, 2)
  progressPct       Decimal   @default(0) @map("progress_pct") @db.Decimal(5, 2)
  version           Int       @default(1)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz(6)

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projectManager User?        @relation("ProjectManager", fields: [projectManagerId], references: [id], onDelete: SetNull)

  members          ProjectMember[]
  taskLists        TaskList[]
  tasks            Task[]
  timesheets       Timesheet[]
  salesOrders      SalesOrder[]
  purchaseOrders   PurchaseOrder[]
  customerInvoices CustomerInvoice[]
  vendorBills      VendorBill[]
  expenses         Expense[]

  @@index([organizationId, status], map: "ix_projects_org_status")
  @@index([organizationId, projectManagerId], map: "ix_projects_org_pm")
  @@map("projects")
}

// Project Members (many-to-many)
model ProjectMember {
  id            Int      @id @default(autoincrement())
  projectId     Int      @map("project_id")
  userId        Int      @map("user_id")
  roleInProject String?  @map("role_in_project")
  assignedAt    DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

// Task Lists / Milestones
model TaskList {
  id        Int    @id @default(autoincrement()) @map("list_id")
  projectId Int    @map("project_id")
  title     String
  ordinal   Int    @default(0)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@map("task_lists")
}

// Tasks
model Task {
  id            Int       @id @default(autoincrement()) @map("task_id")
  projectId     Int       @map("project_id")
  listId        Int?      @map("list_id")
  title         String
  description   String?
  assigneeId    Int?      @map("assignee_id")
  priority      Int       @default(2) @db.SmallInt
  status        String    @default("new")
  estimateHours Decimal?  @map("estimate_hours") @db.Decimal(8, 2)
  hoursLogged   Decimal   @default(0) @map("hours_logged") @db.Decimal(12, 2)
  metadata      Json?     @db.JsonB
  dueDate       DateTime? @map("due_date") @db.Date
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  version       Int       @default(1)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskList TaskList? @relation(fields: [listId], references: [id], onDelete: SetNull)
  assignee User?     @relation(fields: [assigneeId], references: [id], onDelete: SetNull)

  timesheets Timesheet[]
  comments   TaskComment[]

  @@index([projectId, status], map: "ix_tasks_proj_status")
  @@index([assigneeId], map: "ix_tasks_assignee")
  @@map("tasks")
}

// Timesheets (heavy-write table, consider partitioning)
model Timesheet {
  id            Int       @id @default(autoincrement()) @map("timesheet_id")
  projectId     Int       @map("project_id")
  taskId        Int?      @map("task_id")
  userId        Int       @map("user_id")
  start         DateTime  @map("start") @db.Timestamptz(6)
  end           DateTime  @map("end") @db.Timestamptz(6)
  durationHours Decimal   @map("duration_hours") @db.Decimal(8, 2)
  billable      Boolean   @default(true)
  notes         String?
  costAtTime    Decimal   @map("cost_at_time") @db.Decimal(14, 2)
  status        String    @default("draft")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task    Task?   @relation(fields: [taskId], references: [id], onDelete: SetNull)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt], map: "ix_timesheets_project_date")
  @@index([userId, createdAt], map: "ix_timesheets_user_date")
  @@index([taskId], map: "ix_timesheets_task")
  @@index([status], map: "ix_timesheets_status")
  @@map("timesheets")
}

// Sales Orders
model SalesOrder {
  id             Int       @id @default(autoincrement()) @map("so_id")
  organizationId Int       @map("organization_id")
  projectId      Int?      @map("project_id")
  soNumber       String    @map("so_number")
  partnerName    String?   @map("partner_name")
  orderDate      DateTime  @default(dbgenerated("current_date")) @map("order_date") @db.Date
  totalAmount    Decimal   @default(0) @map("total_amount") @db.Decimal(14, 2)
  status         String    @default("draft") // ['draft', 'confirmed', 'invoiced', 'cancelled']
  metadata       Json?     @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)

  customerInvoices CustomerInvoice[]

  @@unique([organizationId, soNumber], map: "ux_so_org_number")
  @@index([organizationId, status], map: "ix_so_org_status")
  @@index([projectId], map: "ix_so_project")
  @@map("sales_orders")
}

// Purchase Orders
model PurchaseOrder {
  id             Int       @id @default(autoincrement()) @map("po_id")
  organizationId Int       @map("organization_id")
  projectId      Int?      @map("project_id")
  poNumber       String    @map("po_number")
  vendorName     String?   @map("vendor_name")
  orderDate      DateTime  @default(dbgenerated("current_date")) @map("order_date") @db.Date
  totalAmount    Decimal   @default(0) @map("total_amount") @db.Decimal(14, 2)
  status         String    @default("draft") // ['draft', 'confirmed', 'billed', 'cancelled']
  metadata       Json?     @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)

  vendorBills VendorBill[]

  @@unique([organizationId, poNumber], map: "ux_po_org_number")
  @@index([organizationId, status], map: "ix_po_org_status")
  @@index([projectId], map: "ix_po_project")
  @@map("purchase_orders")
}

// Customer Invoices
model CustomerInvoice {
  id             Int       @id @default(autoincrement()) @map("invoice_id")
  organizationId Int       @map("organization_id")
  projectId      Int?      @map("project_id")
  soId           Int?      @map("so_id")
  invoiceNumber  String    @map("invoice_number")
  invoiceDate    DateTime  @default(dbgenerated("current_date")) @map("invoice_date") @db.Date
  amount         Decimal   @db.Decimal(14, 2)
  status         String    @default("draft") // ['draft', 'sent', 'paid', 'cancelled']
  metadata       Json?     @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  salesOrder   SalesOrder?  @relation(fields: [soId], references: [id], onDelete: SetNull)

  @@unique([organizationId, invoiceNumber], map: "ux_invoice_org_number")
  @@index([organizationId, status], map: "ix_invoice_org_status")
  @@index([soId], map: "ix_invoice_so")
  @@map("customer_invoices")
}

// Vendor Bills
model VendorBill {
  id             Int       @id @default(autoincrement()) @map("bill_id")
  organizationId Int       @map("organization_id")
  projectId      Int?      @map("project_id")
  poId           Int?      @map("po_id")
  vendorName     String?   @map("vendor_name")
  billDate       DateTime  @default(dbgenerated("current_date")) @map("bill_date") @db.Date
  amount         Decimal   @db.Decimal(14, 2)
  status         String    @default("draft") // ['draft', 'received', 'paid', 'cancelled']
  metadata       Json?     @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project       Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  purchaseOrder PurchaseOrder? @relation(fields: [poId], references: [id], onDelete: SetNull)

  @@index([organizationId, status], map: "ix_bill_org_status")
  @@index([poId], map: "ix_bill_po")
  @@map("vendor_bills")
}

// Expenses (employee)
model Expense {
  id              Int       @id @default(autoincrement()) @map("expense_id")
  organizationId  Int       @map("organization_id")
  projectId       Int?      @map("project_id")
  userId          Int?      @map("user_id")
  amount          Decimal   @db.Decimal(12, 2)
  billable        Boolean   @default(false)
  status          String    @default("draft") // 'draft', 'submitted', 'approved', 'rejected', 'paid'
  receiptUrl      String?   @map("receipt_url")
  note            String?
  rejectionReason String?   @map("rejection_reason")
  approvedBy      Int?      @map("approved_by")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  submittedAt     DateTime? @map("submitted_at") @db.Timestamptz(6)
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz(6)
  paidAt          DateTime? @map("paid_at") @db.Timestamptz(6)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([projectId, status], map: "ix_expenses_proj_status")
  @@index([organizationId, status], map: "ix_expenses_org_status")
  @@index([userId, status], map: "ix_expenses_user_status")
  @@map("expenses")
}

// Attachments
// Production-Grade Attachment Storage with Outbox Pattern
model Attachment {
  id             Int    @id @default(autoincrement()) @map("attachment_id")
  organizationId Int    @map("organization_id")
  ownerType      String @map("owner_type")
  ownerId        Int    @map("owner_id")

  // File metadata
  fileName String? @map("file_name")
  mimeType String? @map("mime_type")
  fileSize Int?    @map("file_size") // Size in bytes

  // Cloudinary primary storage
  fileUrl       String? @map("file_url") // Cloudinary URL (made optional for pending uploads)
  cloudPublicId String? @map("cloud_public_id") // Cloudinary public_id for management

  // PostgreSQL backup/fallback storage
  backupData      Bytes?  @map("backup_data") // Compressed preview/thumbnail stored in DB
  backupType      String? @map("backup_type") // 'thumbnail', 'compressed', 'snippet'
  backupAvailable Boolean @default(false) @map("backup_available")

  // Upload tracking
  uploadedBy     Int?      @map("uploaded_by")
  uploadedAt     DateTime  @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  status         String    @default("active") // 'active', 'pending_upload', 'deleted', 'failed'
  lastVerifiedAt DateTime? @map("last_verified_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploader     User?        @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)

  @@index([ownerType, ownerId], map: "ix_attachments_owner")
  @@index([status], map: "ix_attachments_status")
  @@index([organizationId], map: "ix_attachments_org")
  @@index([cloudPublicId], map: "ix_attachments_cloud_id")
  @@map("attachments")
}

// Outbox Pattern for Eventual Consistency
model OutboxEvent {
  id          Int       @id @default(autoincrement()) @map("event_id")
  eventType   String    @map("event_type") // 'UPLOAD_SUCCESS', 'DELETE_FILE', 'VERIFY_UPLOAD', 'REPAIR_UPLOAD'
  entityType  String    @map("entity_type") // 'Attachment'
  entityId    Int       @map("entity_id")
  payload     Json // Contains Cloudinary data, retry count, etc.
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  processed   Boolean   @default(false)
  processedAt DateTime? @map("processed_at") @db.Timestamptz(6)
  error       String? // Error message if processing failed
  retryCount  Int       @default(0) @map("retry_count")

  @@index([processed, createdAt], map: "ix_outbox_unprocessed")
  @@index([eventType], map: "ix_outbox_event_type")
  @@map("outbox_events")
}

// Task Comments
model TaskComment {
  id        Int      @id @default(autoincrement()) @map("comment_id")
  taskId    Int      @map("task_id")
  userId    Int      @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("task_comments")
}

// Events / Audit Log (append-only)
model Event {
  id             Int      @id @default(autoincrement()) @map("event_id")
  organizationId Int      @map("organization_id")
  entityType     String   @map("entity_type")
  entityId       Int?     @map("entity_id")
  eventType      String   @map("event_type")
  payload        Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("events")
}

// Analytics Cache for Performance Optimization
model AnalyticsCache {
  id                Int      @id @default(autoincrement()) @map("cache_id")
  organizationId    Int      @map("organization_id")
  cacheType         String   @map("cache_type") // 'project_summary', 'finance_summary', 'timesheet_summary', etc.
  data              Json     @db.JsonB // Cached analytics result
  computedAt        DateTime @default(now()) @map("computed_at") @db.Timestamptz(6)
  expiresAt         DateTime @map("expires_at") @db.Timestamptz(6)
  computeDurationMs Int?     @map("compute_duration_ms") // Track query performance

  @@unique([organizationId, cacheType], map: "ux_analytics_org_type")
  @@index([organizationId, cacheType, expiresAt], map: "ix_analytics_lookup")
  @@index([expiresAt], map: "ix_analytics_expires")
  @@map("analytics_cache")
}

// Organization Invitations for onboarding users
model OrganizationInvitation {
  id             Int              @id @default(autoincrement()) @map("invitation_id")
  organizationId Int              @map("organization_id")
  email          String
  role           UserRole         @default(member)
  invitedById    Int              @map("invited_by_id")
  token          String           @unique @default(uuid())
  status         InvitationStatus @default(pending)
  expiresAt      DateTime         @map("expires_at") @db.Timestamptz(6)
  acceptedAt     DateTime?        @map("accepted_at") @db.Timestamptz(6)
  createdAt      DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation(fields: [invitedById], references: [id], onDelete: Cascade)

  @@unique([organizationId, email], map: "ux_invitation_org_email")
  @@index([token, status], map: "ix_invitation_token_status")
  @@index([organizationId, status], map: "ix_invitation_org_status")
  @@map("organization_invitations")
}

// Notifications for In-App and Email Alerts
model Notification {
  id             Int      @id @default(autoincrement()) @map("notification_id")
  organizationId Int      @map("organization_id")
  userId         Int?     @map("user_id")
  type           String // e.g., "TASK_ASSIGNED", "INVOICE_GENERATED", "EXPENSE_APPROVED"
  title          String
  message        String
  data           Json?    @db.JsonB // Additional context (entityId, links, etc.)
  isRead         Boolean  @default(false) @map("is_read")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId, isRead], map: "ix_notifications_user_status")
  @@index([userId, createdAt], map: "ix_notifications_user_date")
  @@map("notifications")
}
