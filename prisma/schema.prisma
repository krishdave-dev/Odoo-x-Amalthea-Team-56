// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [uuidOssp(map: "uuid-ossp")]
}

// Organizations / Tenants
model Organization {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("organization_id")
  name            String
  currency        String   @default("INR") @db.Char(3)
  timezone        String   @default("Asia/Kolkata")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  users           User[]
  projects        Project[]
  salesOrders     SalesOrder[]
  purchaseOrders  PurchaseOrder[]
  customerInvoices CustomerInvoice[]
  vendorBills     VendorBill[]
  expenses        Expense[]
  attachments     Attachment[]
  events          Event[]

  @@map("organizations")
}

// Users (auth + profile)
model User {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("user_id")
  organizationId  String    @db.Uuid @map("organization_id")
  email           String
  name            String?
  passwordHash    String?   @map("password_hash")
  role            String
  hourlyRate      Decimal   @default(0.00) @map("hourly_rate") @db.Decimal(12, 2)
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  managedProjects Project[] @relation("ProjectManager")
  projectMembers  ProjectMember[]
  assignedTasks   Task[]
  timesheets      Timesheet[]
  expenses        Expense[]
  uploadedAttachments Attachment[]
  taskComments    TaskComment[]

  @@unique([organizationId, email], map: "ux_users_org_email")
  @@map("users")
}

// Projects
model Project {
  id                  String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("project_id")
  organizationId      String    @db.Uuid @map("organization_id")
  name                String
  code                String?
  description         String?
  projectManagerId    String?   @db.Uuid @map("project_manager_id")
  startDate           DateTime? @map("start_date") @db.Date
  endDate             DateTime? @map("end_date") @db.Date
  status              String    @default("planned")
  budget              Decimal?  @db.Decimal(14, 2)
  cachedHoursLogged   Decimal   @default(0) @map("cached_hours_logged") @db.Decimal(14, 2)
  cachedCost          Decimal   @default(0) @map("cached_cost") @db.Decimal(14, 2)
  cachedRevenue       Decimal   @default(0) @map("cached_revenue") @db.Decimal(14, 2)
  cachedProfit        Decimal   @default(0) @map("cached_profit") @db.Decimal(14, 2)
  progressPct         Decimal   @default(0) @map("progress_pct") @db.Decimal(5, 2)
  version             Int       @default(1)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt           DateTime? @map("deleted_at") @db.Timestamptz(6)

  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projectManager      User?        @relation("ProjectManager", fields: [projectManagerId], references: [id])
  
  members             ProjectMember[]
  taskLists           TaskList[]
  tasks               Task[]
  timesheets          Timesheet[]
  salesOrders         SalesOrder[]
  purchaseOrders      PurchaseOrder[]
  customerInvoices    CustomerInvoice[]
  vendorBills         VendorBill[]
  expenses            Expense[]

  @@index([organizationId, status], map: "ix_projects_org_status")
  @@index([organizationId, projectManagerId], map: "ix_projects_org_pm")
  @@map("projects")
}

// Project Members (many-to-many)
model ProjectMember {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId       String   @db.Uuid @map("project_id")
  userId          String   @db.Uuid @map("user_id")
  roleInProject   String?  @map("role_in_project")
  assignedAt      DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)

  project         Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

// Task Lists / Milestones
model TaskList {
  id          String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("list_id")
  projectId   String @db.Uuid @map("project_id")
  title       String
  ordinal     Int    @default(0)

  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@map("task_lists")
}

// Tasks
model Task {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("task_id")
  projectId       String    @db.Uuid @map("project_id")
  listId          String?   @db.Uuid @map("list_id")
  title           String
  description     String?
  assigneeId      String?   @db.Uuid @map("assignee_id")
  priority        Int       @default(2) @db.SmallInt
  status          String    @default("new")
  estimateHours   Decimal?  @map("estimate_hours") @db.Decimal(8, 2)
  hoursLogged     Decimal   @default(0) @map("hours_logged") @db.Decimal(12, 2)
  metadata        Json?     @db.JsonB
  dueDate         DateTime? @map("due_date") @db.Date
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  version         Int       @default(1)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)

  project         Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskList        TaskList?  @relation(fields: [listId], references: [id])
  assignee        User?      @relation(fields: [assigneeId], references: [id])
  
  timesheets      Timesheet[]
  comments        TaskComment[]

  @@index([projectId, status], map: "ix_tasks_proj_status")
  @@index([assigneeId], map: "ix_tasks_assignee")
  @@map("tasks")
}

// Timesheets (heavy-write table, consider partitioning)
model Timesheet {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("timesheet_id")
  projectId       String    @db.Uuid @map("project_id")
  taskId          String?   @db.Uuid @map("task_id")
  userId          String    @db.Uuid @map("user_id")
  start           DateTime  @map("start") @db.Timestamptz(6)
  end             DateTime  @map("end") @db.Timestamptz(6)
  durationHours   Decimal   @map("duration_hours") @db.Decimal(8, 2)
  billable        Boolean   @default(true)
  notes           String?
  costAtTime      Decimal   @map("cost_at_time") @db.Decimal(14, 2)
  status          String    @default("draft")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)

  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task?   @relation(fields: [taskId], references: [id], onDelete: SetNull)
  user        User    @relation(fields: [userId], references: [id])

  @@index([projectId, createdAt], map: "ix_timesheets_project_date")
  @@index([userId, createdAt], map: "ix_timesheets_user_date")
  @@index([taskId], map: "ix_timesheets_task")
  @@index([status], map: "ix_timesheets_status")
  @@map("timesheets")
}

// Sales Orders
model SalesOrder {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("so_id")
  organizationId  String   @db.Uuid @map("organization_id")
  projectId       String?  @db.Uuid @map("project_id")
  soNumber        String   @map("so_number")
  partnerName     String?  @map("partner_name")
  orderDate       DateTime @default(dbgenerated("current_date")) @map("order_date") @db.Date
  totalAmount     Decimal  @default(0) @map("total_amount") @db.Decimal(14, 2)
  status          String   @default("draft")
  metadata        Json?    @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project         Project?     @relation(fields: [projectId], references: [id])
  
  customerInvoices CustomerInvoice[]

  @@unique([organizationId, soNumber], map: "ux_so_org_number")
  @@map("sales_orders")
}

// Purchase Orders
model PurchaseOrder {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("po_id")
  organizationId  String   @db.Uuid @map("organization_id")
  projectId       String?  @db.Uuid @map("project_id")
  poNumber        String   @map("po_number")
  vendorName      String?  @map("vendor_name")
  orderDate       DateTime @default(dbgenerated("current_date")) @map("order_date") @db.Date
  totalAmount     Decimal  @default(0) @map("total_amount") @db.Decimal(14, 2)
  status          String   @default("draft")
  metadata        Json?    @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project         Project?     @relation(fields: [projectId], references: [id])
  
  vendorBills     VendorBill[]

  @@unique([organizationId, poNumber], map: "ux_po_org_number")
  @@map("purchase_orders")
}

// Customer Invoices
model CustomerInvoice {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("invoice_id")
  organizationId  String   @db.Uuid @map("organization_id")
  projectId       String?  @db.Uuid @map("project_id")
  soId            String?  @db.Uuid @map("so_id")
  invoiceNumber   String   @map("invoice_number")
  invoiceDate     DateTime @default(dbgenerated("current_date")) @map("invoice_date") @db.Date
  amount          Decimal  @db.Decimal(14, 2)
  status          String   @default("draft")
  metadata        Json?    @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project         Project?     @relation(fields: [projectId], references: [id])
  salesOrder      SalesOrder?  @relation(fields: [soId], references: [id], onDelete: SetNull)

  @@unique([organizationId, invoiceNumber], map: "ux_invoice_org_number")
  @@map("customer_invoices")
}

// Vendor Bills
model VendorBill {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("bill_id")
  organizationId  String   @db.Uuid @map("organization_id")
  projectId       String?  @db.Uuid @map("project_id")
  poId            String?  @db.Uuid @map("po_id")
  vendorName      String?  @map("vendor_name")
  billDate        DateTime @default(dbgenerated("current_date")) @map("bill_date") @db.Date
  amount          Decimal  @db.Decimal(14, 2)
  status          String   @default("draft")
  metadata        Json?    @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project         Project?      @relation(fields: [projectId], references: [id])
  purchaseOrder   PurchaseOrder? @relation(fields: [poId], references: [id])

  @@map("vendor_bills")
}

// Expenses (employee)
model Expense {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("expense_id")
  organizationId  String    @db.Uuid @map("organization_id")
  projectId       String?   @db.Uuid @map("project_id")
  userId          String?   @db.Uuid @map("user_id")
  amount          Decimal   @db.Decimal(12, 2)
  billable        Boolean   @default(false)
  status          String    @default("submitted")
  receiptUrl      String?   @map("receipt_url")
  note            String?
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz(6)

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project         Project?     @relation(fields: [projectId], references: [id])
  user            User?        @relation(fields: [userId], references: [id])

  @@index([projectId, status], map: "ix_expenses_proj_status")
  @@map("expenses")
}

// Attachments
// Production-Grade Attachment Storage with Outbox Pattern
model Attachment {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("attachment_id")
  organizationId  String   @db.Uuid @map("organization_id")
  ownerType       String   @map("owner_type") // 'task', 'project', 'expense', 'invoice'
  ownerId         String   @db.Uuid @map("owner_id")
  fileName        String   @map("file_name")
  mimeType        String   @map("mime_type")
  fileSize        Int      @map("file_size")

  // Primary Cloud Storage (Cloudinary)
  cloudUrl        String?  @map("cloud_url")
  cloudPublicId   String?  @map("cloud_public_id")

  // Fallback Preview/Backup Data
  backupData      Bytes?   @map("backup_data")
  backupType      String?  @map("backup_type") // 'thumbnail', 'compressed', 'text_snippet'
  backupAvailable Boolean  @default(false) @map("backup_available")

  // Status Management
  uploadedBy      String?  @db.Uuid @map("uploaded_by")
  uploadedAt      DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  status          String   @default("active") // 'active', 'pending_upload', 'deleted', 'failed'
  lastVerifiedAt  DateTime? @map("last_verified_at") @db.Timestamptz(6)

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploader        User?        @relation(fields: [uploadedBy], references: [id])

  @@index([ownerType, ownerId], map: "ix_attachments_owner")
  @@index([status], map: "ix_attachments_status")
  @@index([organizationId], map: "ix_attachments_org")
  @@map("attachments")
}

// Outbox Pattern for Eventual Consistency
model OutboxEvent {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("event_id")
  eventType   String    @map("event_type") // 'UPLOAD_SUCCESS', 'DELETE_FILE', 'VERIFY_UPLOAD', 'REPAIR_UPLOAD'
  entityType  String    @map("entity_type") // 'Attachment'
  entityId    String    @db.Uuid @map("entity_id")
  payload     Json      // Contains Cloudinary data, retry count, etc.
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  processed   Boolean   @default(false)
  processedAt DateTime? @map("processed_at") @db.Timestamptz(6)
  error       String?   // Error message if processing failed
  retryCount  Int       @default(0) @map("retry_count")

  @@index([processed, createdAt], map: "ix_outbox_unprocessed")
  @@index([eventType], map: "ix_outbox_event_type")
  @@map("outbox_events")
}

// Task Comments
model TaskComment {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("comment_id")
  taskId      String   @db.Uuid @map("task_id")
  userId      String   @db.Uuid @map("user_id")
  content     String
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  task        Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User @relation(fields: [userId], references: [id])

  @@map("task_comments")
}

// Events / Audit Log (append-only)
model Event {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid @map("event_id")
  organizationId  String   @db.Uuid @map("organization_id")
  entityType      String   @map("entity_type")
  entityId        String?  @db.Uuid @map("entity_id")
  eventType       String   @map("event_type")
  payload         Json?    @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization    Organization @relation(fields: [organizationId], references: [id])

  @@map("events")
}
